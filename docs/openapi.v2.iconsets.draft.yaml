openapi: 3.1.0
info:
  title: GraphAPI v2 Iconsets and Profiles Draft
  version: 0.1.0-draft
  description: >
    Contract-first draft for introducing reusable node-type iconsets into GraphAPI.
    This draft defines iconset CRUD + publish/versioning, deterministic merge
    resolution, profile v2 references, and autocomplete catalog v2 behavior.
servers:
  - url: http://127.0.0.1:8000
tags:
  - name: iconsets
  - name: profiles-v2
  - name: autocomplete-v2
  - name: render

paths:
  /v2/iconsets:
    get:
      tags: [iconsets]
      summary: List iconsets
      operationId: listIconsetsV2
      responses:
        '200':
          description: Iconset summaries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IconsetListResponseV1'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags: [iconsets]
      summary: Create iconset
      operationId: createIconsetV2
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IconsetCreateRequestV1'
      responses:
        '201':
          description: Iconset created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IconsetRecordV1'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/iconsets/{id}:
    get:
      tags: [iconsets]
      summary: Get iconset record (draft + published versions)
      operationId: getIconsetV2
      parameters:
        - $ref: '#/components/parameters/IconsetIdPath'
      responses:
        '200':
          description: Iconset record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IconsetRecordV1'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      tags: [iconsets]
      summary: Update iconset draft (increments version)
      operationId: updateIconsetV2
      parameters:
        - $ref: '#/components/parameters/IconsetIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IconsetUpdateRequestV1'
      responses:
        '200':
          description: Iconset updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IconsetRecordV1'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/iconsets/{id}/bundle:
    get:
      tags: [iconsets]
      summary: Resolve one iconset bundle version
      operationId: getIconsetBundleV2
      parameters:
        - $ref: '#/components/parameters/IconsetIdPath'
        - $ref: '#/components/parameters/StageQuery'
        - $ref: '#/components/parameters/IconsetVersionQuery'
      responses:
        '200':
          description: Iconset bundle
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IconsetBundleV1'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/iconsets/{id}/publish:
    post:
      tags: [iconsets]
      summary: Publish current iconset draft
      operationId: publishIconsetV2
      parameters:
        - $ref: '#/components/parameters/IconsetIdPath'
      responses:
        '200':
          description: Published bundle
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IconsetBundleV1'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/iconsets/resolve:
    post:
      tags: [iconsets]
      summary: Resolve and merge multiple iconsets deterministically
      description: >
        Evaluates iconsets in declared order. Duplicate key handling is controlled by
        conflictPolicy (`reject`, `first-wins`, `last-wins`).
      operationId: resolveIconsetsV2
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IconsetResolveRequestV1'
      responses:
        '200':
          description: Deterministic merge result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IconsetResolutionResultV1'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/profiles:
    get:
      tags: [profiles-v2]
      summary: List v2 profiles
      operationId: listProfilesV2
      responses:
        '200':
          description: Profile summaries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileListResponseV2'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags: [profiles-v2]
      summary: Create v2 profile
      operationId: createProfileV2
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileCreateRequestV2'
      responses:
        '201':
          description: Profile created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileRecordV2'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/profiles/{id}:
    get:
      tags: [profiles-v2]
      summary: Get v2 profile record (draft + published versions)
      operationId: getProfileV2
      parameters:
        - $ref: '#/components/parameters/ProfileIdPath'
      responses:
        '200':
          description: Profile record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileRecordV2'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      tags: [profiles-v2]
      summary: Update v2 profile draft (increments version)
      operationId: updateProfileV2
      parameters:
        - $ref: '#/components/parameters/ProfileIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileUpdateRequestV2'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileRecordV2'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/profiles/{id}/bundle:
    get:
      tags: [profiles-v2]
      summary: Resolve one v2 profile bundle version
      operationId: getProfileBundleV2
      parameters:
        - $ref: '#/components/parameters/ProfileIdPath'
        - $ref: '#/components/parameters/StageQuery'
        - $ref: '#/components/parameters/ProfileVersionQuery'
      responses:
        '200':
          description: Profile bundle
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileBundleV2'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/profiles/{id}/publish:
    post:
      tags: [profiles-v2]
      summary: Publish current v2 profile draft
      operationId: publishProfileV2
      parameters:
        - $ref: '#/components/parameters/ProfileIdPath'
      responses:
        '200':
          description: Published profile bundle
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileBundleV2'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/profiles/{id}/iconset-resolution:
    get:
      tags: [profiles-v2]
      summary: Inspect resolved iconset merge for a profile
      operationId: getProfileIconsetResolutionV2
      parameters:
        - $ref: '#/components/parameters/ProfileIdPath'
        - $ref: '#/components/parameters/StageQuery'
        - $ref: '#/components/parameters/ProfileVersionQuery'
      responses:
        '200':
          description: Resolved type->icon map and provenance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileIconsetResolutionResponseV1'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/autocomplete/catalog:
    get:
      tags: [autocomplete-v2]
      summary: Resolve profile-driven autocomplete catalog
      operationId: getAutocompleteCatalogV2
      parameters:
        - name: profile_id
          in: query
          required: true
          schema:
            type: string
            pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        - $ref: '#/components/parameters/StageQuery'
        - $ref: '#/components/parameters/ProfileVersionQuery'
      responses:
        '200':
          description: Catalog response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutocompleteCatalogResponseV2'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /render/svg:
    post:
      tags: [render]
      summary: Render graph to SVG using resolved profile/theme runtime
      description: >
        Existing endpoint retained. This draft documents new iconset-aware response
        headers for runtime/cache determinism.
      operationId: renderSvg
      parameters:
        - name: profile_id
          in: query
          required: false
          schema:
            type: string
            pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        - name: profile_stage
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/Stage'
        - name: profile_version
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
        - name: theme_id
          in: query
          required: false
          schema:
            type: string
            pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        - name: theme_stage
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/Stage'
        - name: theme_version
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: SVG rendered
          headers:
            X-GraphAPI-Profile-Id:
              schema: { type: string }
            X-GraphAPI-Profile-Version:
              schema: { type: string }
            X-GraphAPI-Profile-Checksum:
              schema:
                type: string
                pattern: '^[a-f0-9]{64}$'
            X-GraphAPI-Theme-Id:
              schema: { type: string }
            X-GraphAPI-Theme-Version:
              schema: { type: string }
            X-GraphAPI-Theme-Checksum:
              schema:
                type: string
                pattern: '^[a-f0-9]{64}$'
            X-GraphAPI-Iconset-Resolution-Checksum:
              schema:
                type: string
                pattern: '^[a-f0-9]{64}$'
            X-GraphAPI-Iconset-Sources:
              schema:
                type: string
                description: Comma-separated `iconsetId@version` list in merge order.
            X-GraphAPI-Runtime-Checksum:
              schema:
                type: string
                pattern: '^[a-f0-9]{64}$'
          content:
            image/svg+xml:
              schema:
                type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  parameters:
    IconsetIdPath:
      name: id
      in: path
      required: true
      schema:
        type: string
        pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
    ProfileIdPath:
      name: id
      in: path
      required: true
      schema:
        type: string
        pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
    StageQuery:
      name: stage
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/Stage'
    IconsetVersionQuery:
      name: iconset_version
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
    ProfileVersionQuery:
      name: profile_version
      in: query
      required: false
      schema:
        type: integer
        minimum: 1

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    Stage:
      type: string
      enum: [draft, published]
      default: published

    IconConflictPolicy:
      type: string
      enum: [reject, first-wins, last-wins]
      default: reject

    Sha256Hex:
      type: string
      pattern: '^[a-f0-9]{64}$'

    ErrorBody:
      type: object
      additionalProperties: false
      required: [code, message]
      properties:
        code:
          type: string
          description: >
            Stable code values include ICONSET_ID_INVALID, ICONSET_ENTRY_KEY_INVALID,
            ICONSET_ENTRY_VALUE_INVALID, ICONSET_ENTRY_DUPLICATE, ICONSET_KEY_CONFLICT,
            ICONSET_REF_NOT_FOUND, ICONSET_VERSION_NOT_FOUND, PROFILE_ICONSET_REF_INVALID.
        message:
          type: string
        details:
          type: object
          additionalProperties: true
          description: >
            Structured diagnostics, e.g. { field, path, value, rule, conflicts[] }.

    ErrorResponse:
      type: object
      additionalProperties: false
      required: [error]
      properties:
        error:
          $ref: '#/components/schemas/ErrorBody'

    IconsetEntries:
      type: object
      description: Node-type key to Iconify icon name map.
      minProperties: 1
      maxProperties: 2000
      patternProperties:
        '^(?=.{2,64}$)[a-z][a-z0-9_-]*$':
          type: string
          pattern: '^(?=.{3,128}$)[a-z0-9]+(?:-[a-z0-9]+)*:[a-z0-9]+(?:[-_][a-z0-9]+)*$'
      additionalProperties: false

    ResolvedTypeIconMap:
      type: object
      description: Deterministically resolved profile type->icon map.
      minProperties: 1
      maxProperties: 5000
      patternProperties:
        '^(?=.{2,64}$)[a-z][a-z0-9_-]*$':
          type: string
          pattern: '^(?=.{3,128}$)[a-z0-9]+(?:-[a-z0-9]+)*:[a-z0-9]+(?:[-_][a-z0-9]+)*$'
      additionalProperties: false

    LinkTypeList:
      type: array
      minItems: 1
      maxItems: 256
      uniqueItems: true
      items:
        type: string
        pattern: '^(?=.{1,64}$)[a-z][a-z0-9_-]*$'

    IconsetCreateRequestV1:
      type: object
      additionalProperties: false
      required: [iconsetId, name, entries]
      properties:
        iconsetId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        name:
          type: string
          minLength: 1
          maxLength: 120
        entries:
          $ref: '#/components/schemas/IconsetEntries'

    IconsetUpdateRequestV1:
      type: object
      additionalProperties: false
      required: [name, entries]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 120
        entries:
          $ref: '#/components/schemas/IconsetEntries'

    IconsetBundleV1:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - iconsetId
        - iconsetVersion
        - name
        - entries
        - updatedAt
        - checksum
      properties:
        schemaVersion:
          type: string
          const: v1
        iconsetId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        iconsetVersion:
          type: integer
          minimum: 1
        name:
          type: string
          minLength: 1
          maxLength: 120
        entries:
          $ref: '#/components/schemas/IconsetEntries'
        updatedAt:
          type: string
          format: date-time
        checksum:
          $ref: '#/components/schemas/Sha256Hex'

    IconsetSummaryV1:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - iconsetId
        - name
        - draftVersion
        - updatedAt
        - checksum
      properties:
        schemaVersion:
          type: string
          const: v1
        iconsetId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        name:
          type: string
        draftVersion:
          type: integer
          minimum: 1
        publishedVersion:
          type: integer
          minimum: 1
          nullable: true
        updatedAt:
          type: string
          format: date-time
        checksum:
          $ref: '#/components/schemas/Sha256Hex'

    IconsetRecordV1:
      type: object
      additionalProperties: false
      required: [schemaVersion, iconsetId, draft, publishedVersions]
      properties:
        schemaVersion:
          type: string
          const: v1
        iconsetId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        draft:
          $ref: '#/components/schemas/IconsetBundleV1'
        publishedVersions:
          type: array
          items:
            $ref: '#/components/schemas/IconsetBundleV1'

    IconsetListResponseV1:
      type: object
      additionalProperties: false
      required: [iconsets]
      properties:
        iconsets:
          type: array
          items:
            $ref: '#/components/schemas/IconsetSummaryV1'

    IconsetResolutionRefV1:
      type: object
      additionalProperties: false
      required: [iconsetId, stage]
      properties:
        iconsetId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        stage:
          $ref: '#/components/schemas/Stage'
        iconsetVersion:
          type: integer
          minimum: 1
          nullable: true

    IconsetResolveRequestV1:
      type: object
      additionalProperties: false
      required: [iconsetRefs, conflictPolicy]
      properties:
        iconsetRefs:
          type: array
          minItems: 1
          maxItems: 8
          items:
            $ref: '#/components/schemas/IconsetResolutionRefV1'
        conflictPolicy:
          $ref: '#/components/schemas/IconConflictPolicy'

    IconsetSourceRefV1:
      type: object
      additionalProperties: false
      required: [iconsetId, iconsetVersion, checksum]
      properties:
        iconsetId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        iconsetVersion:
          type: integer
          minimum: 1
        checksum:
          $ref: '#/components/schemas/Sha256Hex'

    NodeTypeSourceV1:
      type: object
      additionalProperties: false
      required: [key, icon, selectedFrom]
      properties:
        key:
          type: string
          pattern: '^(?=.{2,64}$)[a-z][a-z0-9_-]*$'
        icon:
          type: string
          pattern: '^(?=.{3,128}$)[a-z0-9]+(?:-[a-z0-9]+)*:[a-z0-9]+(?:[-_][a-z0-9]+)*$'
        selectedFrom:
          $ref: '#/components/schemas/IconsetSourceRefV1'
        candidates:
          type: array
          items:
            $ref: '#/components/schemas/IconsetSourceRefV1'

    IconsetResolutionResultV1:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - conflictPolicy
        - resolvedEntries
        - sources
        - keySources
        - checksum
      properties:
        schemaVersion:
          type: string
          const: v1
        conflictPolicy:
          $ref: '#/components/schemas/IconConflictPolicy'
        resolvedEntries:
          $ref: '#/components/schemas/ResolvedTypeIconMap'
        sources:
          type: array
          items:
            $ref: '#/components/schemas/IconsetSourceRefV1'
        keySources:
          type: object
          patternProperties:
            '^(?=.{2,64}$)[a-z][a-z0-9_-]*$':
              $ref: '#/components/schemas/NodeTypeSourceV1'
          additionalProperties: false
        checksum:
          $ref: '#/components/schemas/Sha256Hex'

    ProfileIconsetRefV1:
      type: object
      additionalProperties: false
      required: [iconsetId, iconsetVersion]
      properties:
        iconsetId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        iconsetVersion:
          type: integer
          minimum: 1
        checksum:
          $ref: '#/components/schemas/Sha256Hex'
          nullable: true

    ProfileCreateRequestV2:
      type: object
      additionalProperties: false
      required: [profileId, name, linkTypes, elkSettings, iconsetRefs, iconConflictPolicy]
      properties:
        profileId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        name:
          type: string
          minLength: 1
          maxLength: 120
        linkTypes:
          $ref: '#/components/schemas/LinkTypeList'
        elkSettings:
          type: object
          additionalProperties: true
        iconsetRefs:
          type: array
          minItems: 1
          maxItems: 8
          items:
            $ref: '#/components/schemas/ProfileIconsetRefV1'
        iconConflictPolicy:
          $ref: '#/components/schemas/IconConflictPolicy'

    ProfileUpdateRequestV2:
      type: object
      additionalProperties: false
      required: [name, linkTypes, elkSettings, iconsetRefs, iconConflictPolicy]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 120
        linkTypes:
          $ref: '#/components/schemas/LinkTypeList'
        elkSettings:
          type: object
          additionalProperties: true
        iconsetRefs:
          type: array
          minItems: 1
          maxItems: 8
          items:
            $ref: '#/components/schemas/ProfileIconsetRefV1'
        iconConflictPolicy:
          $ref: '#/components/schemas/IconConflictPolicy'

    ProfileBundleV2:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - profileId
        - profileVersion
        - name
        - nodeTypes
        - linkTypes
        - elkSettings
        - iconsetRefs
        - iconConflictPolicy
        - typeIconMap
        - iconsetResolutionChecksum
        - updatedAt
        - checksum
      properties:
        schemaVersion:
          type: string
          const: v2
        profileId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        profileVersion:
          type: integer
          minimum: 1
        name:
          type: string
          minLength: 1
          maxLength: 120
        nodeTypes:
          type: array
          minItems: 1
          maxItems: 5000
          uniqueItems: true
          items:
            type: string
            pattern: '^(?=.{2,64}$)[a-z][a-z0-9_-]*$'
          description: Resolved keys from typeIconMap, sorted lexicographically.
        linkTypes:
          $ref: '#/components/schemas/LinkTypeList'
        elkSettings:
          type: object
          additionalProperties: true
        iconsetRefs:
          type: array
          minItems: 1
          maxItems: 8
          items:
            $ref: '#/components/schemas/ProfileIconsetRefV1'
        iconConflictPolicy:
          $ref: '#/components/schemas/IconConflictPolicy'
        typeIconMap:
          $ref: '#/components/schemas/ResolvedTypeIconMap'
        iconsetResolutionChecksum:
          $ref: '#/components/schemas/Sha256Hex'
        updatedAt:
          type: string
          format: date-time
        checksum:
          $ref: '#/components/schemas/Sha256Hex'

    ProfileSummaryV2:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - profileId
        - name
        - draftVersion
        - updatedAt
        - checksum
        - iconsetResolutionChecksum
      properties:
        schemaVersion:
          type: string
          const: v2
        profileId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        name:
          type: string
        draftVersion:
          type: integer
          minimum: 1
        publishedVersion:
          type: integer
          minimum: 1
          nullable: true
        updatedAt:
          type: string
          format: date-time
        checksum:
          $ref: '#/components/schemas/Sha256Hex'
        iconsetResolutionChecksum:
          $ref: '#/components/schemas/Sha256Hex'

    ProfileRecordV2:
      type: object
      additionalProperties: false
      required: [schemaVersion, profileId, draft, publishedVersions]
      properties:
        schemaVersion:
          type: string
          const: v2
        profileId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        draft:
          $ref: '#/components/schemas/ProfileBundleV2'
        publishedVersions:
          type: array
          items:
            $ref: '#/components/schemas/ProfileBundleV2'

    ProfileListResponseV2:
      type: object
      additionalProperties: false
      required: [profiles]
      properties:
        profiles:
          type: array
          items:
            $ref: '#/components/schemas/ProfileSummaryV2'

    ProfileIconsetResolutionResponseV1:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - profileId
        - profileVersion
        - profileChecksum
        - conflictPolicy
        - resolvedEntries
        - sources
        - keySources
        - checksum
      properties:
        schemaVersion:
          type: string
          const: v1
        profileId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        profileVersion:
          type: integer
          minimum: 1
        profileChecksum:
          $ref: '#/components/schemas/Sha256Hex'
        conflictPolicy:
          $ref: '#/components/schemas/IconConflictPolicy'
        resolvedEntries:
          $ref: '#/components/schemas/ResolvedTypeIconMap'
        sources:
          type: array
          items:
            $ref: '#/components/schemas/IconsetSourceRefV1'
        keySources:
          type: object
          patternProperties:
            '^(?=.{2,64}$)[a-z][a-z0-9_-]*$':
              $ref: '#/components/schemas/NodeTypeSourceV1'
          additionalProperties: false
        checksum:
          $ref: '#/components/schemas/Sha256Hex'

    AutocompleteCatalogResponseV2:
      type: object
      additionalProperties: false
      required:
        - schemaVersion
        - profileId
        - profileVersion
        - profileChecksum
        - iconsetResolutionChecksum
        - checksum
        - nodeTypes
        - linkTypes
      properties:
        schemaVersion:
          type: string
          const: v2
        profileId:
          type: string
          pattern: '^[a-z0-9][a-z0-9_-]{1,63}$'
        profileVersion:
          type: integer
          minimum: 1
        profileChecksum:
          $ref: '#/components/schemas/Sha256Hex'
        iconsetResolutionChecksum:
          $ref: '#/components/schemas/Sha256Hex'
        checksum:
          $ref: '#/components/schemas/Sha256Hex'
          description: Catalog checksum for client cache keys.
        nodeTypes:
          type: array
          minItems: 1
          maxItems: 5000
          uniqueItems: true
          items:
            type: string
            pattern: '^(?=.{2,64}$)[a-z][a-z0-9_-]*$'
        linkTypes:
          $ref: '#/components/schemas/LinkTypeList'
        nodeTypeSources:
          type: object
          description: Optional source metadata for inspection UX.
          patternProperties:
            '^(?=.{2,64}$)[a-z][a-z0-9_-]*$':
              $ref: '#/components/schemas/IconsetSourceRefV1'
          additionalProperties: false
